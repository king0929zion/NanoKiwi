# Build and sign NanoWiki APK
name: 'Build NanoWiki APK'

on:
  push:
    # Build on all branch pushes
    # Tags are also included in push events
  pull_request:
    branches:
      - main
      - master
      - kiwi
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target platform (arm, arm64, x86, x64)'
        required: true
        default: 'arm64'
        type: choice
        options:
          - arm
          - arm64
          - x86
          - x64

env:
  ANDROID_API_LEVEL: 33
  JAVA_VERSION: 17

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours timeout for Chromium builds
    
    strategy:
      fail-fast: false
      matrix:
        platform: ['arm64']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            python3-pip \
            python3-dev \
            openjdk-${{ env.JAVA_VERSION }}-jdk-headless \
            ccache \
            git \
            curl \
            wget \
            unzip \
            rsync \
            build-essential \
            ninja-build \
            pkg-config \
            libnss3-dev \
            libatk-bridge2.0-dev \
            libdrm2 \
            libxkbcommon-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxrandr-dev \
            libgbm-dev \
            libasound2-dev \
            libpango1.0-dev

      - name: Check disk space
        run: |
          echo "Checking available disk space..."
          df -h
          echo "Current directory: $(pwd)"
          echo "Available space:"
          df -h . | tail -1

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          target: default
          arch: x86_64

      - name: Configure Android environment
        run: |
          if [ -z "$ANDROID_SDK_ROOT" ]; then
            echo "Error: ANDROID_SDK_ROOT is not set"
            exit 1
          fi
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"

      - name: Install depot_tools
        run: |
          echo "=== Installing depot_tools ==="
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git || {
            echo "Error: Failed to clone depot_tools"
            exit 1
          }
          export PATH="$PWD/depot_tools:$PATH"
          echo "$PWD/depot_tools" >> "$GITHUB_PATH"
          echo "Verifying gclient installation..."
          gclient --version || {
            echo "Error: gclient not found after installation"
            exit 1
          }
          echo "depot_tools installed successfully"

      - name: Setup signing key
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "Using provided keystore from secrets"
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
            echo "keystore_password=${{ secrets.KEYSTORE_PASSWORD }}" > keystore.properties
            echo "key_alias=${{ secrets.KEY_ALIAS || 'nanowiki' }}" >> keystore.properties
            echo "key_password=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          else
            echo "Generating temporary keystore for testing"
            keytool -genkey -v \
              -keystore keystore.jks \
              -alias nanowiki \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass nanowiki123 \
              -keypass nanowiki123 \
              -dname "CN=NanoWiki Browser, OU=Development, O=NanoWiki, L=Unknown, ST=Unknown, C=CN"
            echo "keystore_password=nanowiki123" > keystore.properties
            echo "key_alias=nanowiki" >> keystore.properties
            echo "key_password=nanowiki123" >> keystore.properties
          fi


      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-chromium-${{ matrix.platform }}
          max-size: 2G

      - name: Setup Chromium source tree
        timeout-minutes: 180
        run: |
          echo "=== Starting Chromium source tree setup ==="
          echo "Current directory: $(pwd)"
          echo "Disk space before sync:"
          df -h .
          
          export PATH="$PWD/depot_tools:$PATH"
          
          # Verify depot_tools is in PATH
          if ! command -v gclient &> /dev/null; then
            echo "Error: gclient not found in PATH"
            echo "PATH=$PATH"
            exit 1
          fi
          
          echo "gclient version:"
          gclient --version || echo "Warning: gclient --version failed"
          
          # Create .gclient file to sync Chromium source
          cat > .gclient << 'EOF'
          solutions = [
            {
              "name": "src",
              "url": "https://chromium.googlesource.com/chromium/src.git@main",
              "managed": False,
              "custom_deps": {},
            },
          ]
          EOF
          
          echo ".gclient file created:"
          cat .gclient
          
          # Sync Chromium source code (shallow sync to save time and space)
          echo "Syncing Chromium source code (this may take 30-60 minutes)..."
          echo "This is a large download (~10GB+), please be patient..."
          
          # Retry logic for gclient sync
          MAX_RETRIES=3
          RETRY_COUNT=0
          SYNC_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "=== Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES ==="
            echo "Disk space before sync attempt:"
            df -h .
            
            set +e  # Don't exit on error
            # Use timeout to prevent hanging, but allow enough time for sync
            timeout 3600 gclient sync --no-history --shallow --jobs=8 --nohooks --verbose 2>&1 | tee sync.log
            SYNC_EXIT_CODE=${PIPESTATUS[0]}
            set -e
            
            if [ $SYNC_EXIT_CODE -eq 0 ]; then
              SYNC_SUCCESS=true
              echo "=== Sync completed successfully ==="
              break
            elif [ $SYNC_EXIT_CODE -eq 124 ]; then
              echo "=== Sync timed out after 60 minutes ==="
              echo "This is expected for large syncs, checking partial progress..."
              if [ -d "src" ] && [ -f "src/.gclient_entries" ]; then
                echo "Partial sync detected, will continue with existing files"
                SYNC_SUCCESS=true  # Treat partial sync as success for now
                break
              fi
            else
              echo "=== gclient sync failed with exit code: $SYNC_EXIT_CODE ==="
              echo "Last 100 lines of sync.log:"
              tail -100 sync.log || echo "No sync.log found"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Sync failed, waiting 60 seconds before retry..."
                sleep 60
              fi
            fi
          done
          
          if [ "$SYNC_SUCCESS" = false ]; then
            echo "=== Error: gclient sync failed after $MAX_RETRIES attempts ==="
            echo "Checking if src directory exists..."
            if [ -d "src" ]; then
              echo "Warning: Partial sync detected, checking contents..."
              ls -la src/ | head -20 || echo "Cannot list src directory"
              echo "Continuing with existing files..."
            else
              echo "Error: Chromium source directory 'src' not found"
              echo "Current directory contents:"
              ls -la | head -20
              exit 1
            fi
          else
            echo "=== Chromium sync completed successfully ==="
            echo "Disk space after sync:"
            df -h .
          fi
          
          # Copy current repository files over Chromium source (overwrite with custom changes)
          if [ -d "src" ]; then
            echo "Applying custom changes from repository..."
            rsync -av --exclude='.git' --exclude='.github' --exclude='out' --exclude='.gclient' --exclude='src' ./ src/ || {
              echo "Warning: Failed to apply custom changes, continuing anyway..."
            }
            echo "Custom changes applied successfully"
          else
            echo "Error: Chromium source directory 'src' not found after sync"
            exit 1
          fi

      - name: Generate build files
        run: |
          export PATH="$PWD/depot_tools:$PATH"
          cd src || exit 1
          mkdir -p out/Default
          cat > out/Default/args.gn << 'EOF'
          target_os = "android"
          target_cpu = "${{ matrix.platform }}"
          is_debug = false
          is_official_build = true
          symbol_level = 1
          enable_nacl = false
          enable_remoting = false
          enable_webview = false
          is_component_build = false
          use_goma = false
          use_remoteexec = false
          use_siso = false
          android_channel = "stable"
          android_default_version_name = "1.0.${{ github.run_number }}"
          android_default_version_code = "${{ github.run_number }}000000"
          EOF
          cat out/Default/args.gn
          gn gen out/Default
        continue-on-error: true

      - name: Build APK
        timeout-minutes: 300
        run: |
          export PATH="$PWD/depot_tools:$PATH"
          export CCACHE_DIR="$HOME/.ccache"
          cd src || exit 1
          ccache -M 2G
          ccache -s
          autoninja -C out/Default chrome_public_apk
        continue-on-error: true

      - name: Find and sign APK
        if: always()
        run: |
          cd src || exit 1
          # Find the built APK
          if [ -f "out/Default/apks/ChromePublic.apk" ]; then
            APK_FILE="out/Default/apks/ChromePublic.apk"
          elif [ -f "out/Default/apks/Chrome.apk" ]; then
            APK_FILE="out/Default/apks/Chrome.apk"
          else
            APK_FILE=$(find out/Default -name "*.apk" -type f | head -1)
          fi
          
          if [ -z "$APK_FILE" ] || [ ! -f "$APK_FILE" ]; then
            echo "No APK found. Build may have failed."
            exit 1
          fi
          
          echo "Found APK: $APK_FILE"
          
          # Copy keystore files to src directory
          cp ../keystore.jks . || cp keystore.jks . || true
          cp ../keystore.properties . || cp keystore.properties . || true
          
          # Read keystore properties
          source keystore.properties
          
          # Sign APK
          SIGNED_APK="NanoWiki-${{ matrix.platform }}-v${{ github.run_number }}-signed.apk"
          
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore keystore.jks \
            -storepass "$keystore_password" \
            -keypass "$key_password" \
            "$APK_FILE" \
            "$key_alias"
          
          # Align APK
          zipalign -v 4 "$APK_FILE" "${SIGNED_APK}"
          
          # Verify signature
          jarsigner -verify -verbose -certs "$SIGNED_APK"
          
          # Copy signed APK back to workspace root
          cp "$SIGNED_APK" "../${SIGNED_APK}" || true
          
          echo "APK_FILE=src/${SIGNED_APK}" >> "$GITHUB_ENV"
          echo "APK_SIZE=$(du -h "${SIGNED_APK}" | cut -f1)" >> "$GITHUB_ENV"

      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nanowiki-apk-${{ matrix.platform }}
          path: |
            ${{ env.APK_FILE }}
            src/out/Default/apks/*.apk
            NanoWiki-*.apk
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: NanoWiki ${{ github.ref_name }}
          body: |
            ## NanoWiki Browser Release
            
            **Platform**: ${{ matrix.platform }}
            **Build Number**: ${{ github.run_number }}
            **Commit**: ${{ github.sha }}
            **APK Size**: ${{ env.APK_SIZE }}
            
            ### Installation Instructions
            
            1. Download the APK for your device architecture:
               - **arm64**: Modern devices (recommended)
               - **arm**: Older devices  
               - **x86/x64**: Emulators and Intel tablets
            
            2. Enable "Install from unknown sources" in Android settings
            
            3. Install the APK
            
            ### Features
            
            - Built-in Wiki AI Assistant
            - Anthropic/Claude style UI
            - Mobile-optimized interface
            - Privacy-focused browsing
            
            ### Notes
            
            This is an automated build from GitHub Actions. The APK is signed with the development key.
          files: ${{ env.APK_FILE }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.platform }}
          path: |
            src/out/Default/*.log
            src/out/Default/.ninja_log
          retention-days: 7
